<div class="media-options">
    <button onclick="downloadAll()" title="<?= $this->t('download_zip') ?>"><?= $this->include('icons/zip.svg') ?></button>
    <button <?php if (!$can_edit_media): ?> disabled <?php endif ?> onclick="openCreateFolderDialog()" title="<?= $this->t('create_folder') ?>"><?= $this->include('icons/folder.svg') ?></button>
    <div id="file-form">
        <button onclick="get('#input-file').click()" title="<?= $this->t('upload_file') ?>" <?php if (!$can_edit_media): ?> disabled <?php endif ?>><?= $this->include('icons/upload_file.svg') ?></button>
        <input id="input-file" type="file" class="hidden" name="file" oninput="uploadFile()"/>
    </div>
</div>

<div id="folder-dialog" class="dialog">
    <div>
        <div class="top">
            <div class="title">
                <h2><?= $this->t('create_folder') ?></h2>
                <span onclick="Dialog.close(get('#folder-dialog'))">
                    <?= $this->include('icons/x.svg') ?>
                </span>
            </div>
        </div>
        <div class="content input-group">
            <label for="folder-input"><?= $this->t('name') ?></label>
            <input id="folder-input" type="text" name="name"/>
        </div>
        <div class="bottom">
            <button class="light" onclick="Dialog.close(get('#folder-dialog'))"><?= $this->t('cancel') ?></button>
            <button onclick="createFolder()"><?= $this->t('create') ?></button>
        </div>
    </div>
</div>
<script>
    let path = <?= js($_GET['path'] ?? \Aurora\Core\Kernel::config('content')) ?>;
    let file_name = null;
    let files_names = [];
    let content = get('.content');

    function uploadFile() {
        Form.send('/admin/media/upload' + window.location.search, 'file-form', get('#file-form button'), {
            csrf: csrf_token,
        }).then(res => {
            Listing.handleResponse(res);
            get('#input-file').value = '';
        });
    }

    function deleteFiles(files) {
        if (confirm(typeof files === 'string' ? LANG.delete_confirm.sprintf(files) : LANG.delete_confirm_selected)) {
            if (typeof files === 'string') {
                files = [ files ];
            }

            Form.send('/admin/media/remove', null, null, {
                csrf: csrf_token,
                paths: JSON.stringify(files.map(file => path + '/' + file)),
            }).then(res => Listing.handleResponse(res));
        }
    }

    function openCreateFolderDialog() {
        get('#folder-input').value = '';
        let dialog = get('#folder-dialog');
        removeErrors(dialog);
        Dialog.show(dialog);
    }

    function createFolder() {
        Form.send('/admin/media/create_folder' + window.location.search, 'folder-dialog', null, {
            csrf: csrf_token,
        }).then(res => Listing.handleResponse(res));
    }

    function downloadAll() {
        if (confirm(LANG.download_media_description)) {
            location = '/admin/settings/media_download?path=' + path;
        }
    }

    function removeErrors(dialog) {
        dialog.querySelectorAll('.field-error').forEach(el => el.remove());
    }

    content.addEventListener('dragover', event => event.preventDefault());

    content.addEventListener('drop', function(event) {
        event.preventDefault();

        document.body.style.cursor = 'wait';
        let data = new FormData();
        data.append('csrf', csrf_token);
        Array.from(event.dataTransfer.files).map(file => data.append('file[]', file));

        fetch('/admin/media/upload' + window.location.search, {
            method: 'POST',
            body: data,
        })
        .then(res => res.json())
        .then(res => {
            if (res.success) {
                Snackbar.show(LANG.done);
            } else if (res.errors && res.errors.hasOwnProperty(0)) {
                Snackbar.show(res.errors[0], false);
            }

            Listing.handleResponse(res);
        })
        .catch(() => Snackbar.show(LANG.unexpected_error, false))
        .finally(() => document.body.style.cursor = 'default');
    });
</script>
